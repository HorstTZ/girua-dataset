---
title: "Modelagem geoestatística do carbono orgânico do solo"
author: "Moura-Bueno"
date: "12 de dezembro de 2017"
output: html_document
  #bookdown::word_document2:
      #reference_docx: ../docs/template.docx
      #bibliography: biblio.bib
csl: abnt.csl
lang: pt

---
```{r, eval=FALSE}
rmarkdown::render('main.Rmd', encoding = 'UTF-8', output_dir = "../docs")
```

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

```{r, echo=FALSE, include=FALSE}

# Pacotes 
rm(list = ls())
library(magrittr)
library(dplyr)
library(glue)
library(lattice)
library(sp)
library(raster)
library(caret)
library(georob)
library(gstat)


```

```{r}

# Sistemas de referência de coordenadas (Fonte: http://spatialreference.org/ref/epsg/)
wgs84utm21s <- sp::CRS('+proj=utm +zone=21 +south +ellps=WGS84 +datum=WGS84 +units=m +no_defs')
sirgas2000 <- sp::CRS('+proj=longlat +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +no_defs')

# Definir rampas de cores
  col_soil_var1 <- topo.colors(100)
  col_soil_var2 <- terrain.colors(100)

```

```{r}
# Carregar dados 

pontos <- read.csv('../data/pontos-261-srad.csv', sep = ";", dec = ".", h=T)
sp::coordinates(pontos) <- c('x', 'y')
#str(pontos)
sp::proj4string(pontos)<-wgs84utm21s
#pontos@data
pontos <- sp::spTransform(pontos, wgs84utm21s)

```

```{r, fig.asp=1}
summary(pontos)
hist(pontos$soc)
pontos$socbx <- fifer::boxcoxR(pontos$soc)
str(pontos)
hist(pontos$socbx)
```

```{r}
# carregar raster e shapes
ELEV <- raster::raster('../data/ELEV.tif')
sp::proj4string(ELEV)<-wgs84utm21s

DECL <- raster::raster('../data/DECL.tif')
sp::proj4string(DECL)<-wgs84utm21s

SAVI <- raster::raster('../data/SAVI.tif')
sp::proj4string(SAVI)<-wgs84utm21s

B456 <- raster::raster('../data/B456.tif')
sp::proj4string(B456)<-wgs84utm21s

#uso <- raster::shapefile('../data/classes_cobertura_solo_micro_bacia.shp')
#uso <- sp::spTransform(uso, wgs84utm21s)

limite <- raster::shapefile('../data/limite_area_girua.shp')
limite <- sp::spTransform(limite, wgs84utm21s)

# para verificar se os rasters são iguais 
#compareRaster(elev, decli)
```

```{r}

uso$id <- as.factor(uso$id)
sp::spplot(uso, scales = list(draw = TRUE)) +
  lattice::xyplot(y ~ x, data = as.data.frame(pontos@coords), 
                  pch = 20, col = 'red', lwd = 2, cex = 2) %>% 
  latticeExtra::as.layer()
```

```{r}
pontos$ELEV <- raster::extract(ELEV, pontos)

pontos$DECL <- raster::extract(DECL, pontos)

pontos$SAVI <- raster::extract(SAVI, pontos)

pontos$B456 <- raster::extract(B456, pontos)

#pontos$uso <- sp::over(x = pontos, y = uso) %>% unlist()



```

```{r}
soc_rf <- caret::train((soc ~ ELEV), data = pontos@data, method = "rf", tuneLength = 1, ntree = 100, importance = TRUE, na.action = na.omit, trControl = trainControl("LOOCV"))


```

```{r}
pontos@data$socpred <- soc_rf$finalModel$predicted
stats::lm(soc ~ socpred, data= pontos) %>% 
plot()
```

```{r}

beginCluster()
prediction <-
  clusterR(brick(ELEV), raster::predict, args = list(model = soc_rf, type = 'raw', inde = 1))
endCluster()
plot(prediction)
```

```{r}
pontos$prediction <- raster::extract(prediction, pontos)
pontos@data
str(pontos)

```

```{r}
distmax <- dist(pontos@coords) %>% 
  max()/3

```

```{r}
limites <- seq(0, distmax, length.out = 10)
vario <- georob::sample.variogram(socbx ~ prediction, data = pontos,
    locations = ~ x + y, lag.dist.def = limites, estimador = 'matheron') %>% 
  plot(ylab = 'Semivariância', xlab = 'Distância de separação (m)', annotate.npairs = T)
```

```{r}
vario_fit <-
  georob::fit.variogram.model(vario, variogram.model = 'RMspheric', param = c(variance = 0.05, nugget = 0.03, scale = 0.02),  weighting.method = "cressie", method = 'BFGS')
summary(vario_fit)
```

```{r}
plot(vario, type = 'b')
lines(vario_fit, col = 'red', lty = 'dashed')


```

```{r}
vario_fit_error <- georob::georob(
   socbx ~ prediction, pontos, locations = ~ x + y, variogram.model = 'RMexp', 
 param = c(variance = vario_fit$variogram.object[[1]]$param[['variance']], 
           nugget = vario_fit$variogram.object[[1]]$param[['nugget']]*0.66,
           snugget = vario_fit$variogram.object[[1]]$param[['nugget']]*0.33,
           scale = vario_fit$variogram.object[[1]]$param[['scale']]),
 fit.param = georob::default.fit.param(nugget = FALSE, snugget = FALSE),
 tuning.psi = 1000, control = georob::control.georob(initial.fixef = 'lm'))
summary(vario_fit_error)
```

```{r}
plot(vario)
lines(vario_fit_error)
```

```{r}

grid <- sp::spsample(limite, 10000, type = 'regular')
plot(grid@coords, asp=1)
colnames(grid@coords) <- colnames(pontos@coords)
```

```{r}
grid$socprediction <- raster::extract(prediction, grid)

grid$B456 <- raster::extract(B456, grid)
```


```{r}
grid <- 
 sp::SpatialPointsDataFrame(
   coords = grid@coords, 
   data = data.frame(grid),
   proj4string = grid@proj4string)
colnames(grid@coords) <- colnames(pontos@coords)
```

```{r}
pred_ponto <- predict(vario_fit_error, newdata = grid, na.action = na.omit, control = georob::control.predict.georob(extended.output = TRUE))
sp::gridded(pred_ponto) <- TRUE
sp::spplot(pred_ponto)

```

```{r}
pred_ponto <- predict(soc_rf, newdata = grid, control = georob::control.predict.georob(extended.output = TRUE)) sp::gridded(pred_ponto) <- TRUE str(pred_ponto)
```

