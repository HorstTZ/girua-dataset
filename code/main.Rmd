---
title: "Modelagem geoestatística do carbono orgânico do solo"
author: "Moura-Bueno"
date: "12 de dezembro de 2017"
output: html_document
  #bookdown::word_document2:
      #reference_docx: ../docs/template.docx
      #bibliography: biblio.bib
csl: abnt.csl
lang: pt
editor_options: 
  chunk_output_type: inline
---
```{r, eval=FALSE}
rmarkdown::render('main.Rmd', encoding = 'UTF-8', output_dir = "../docs")
```

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

```{r, echo=FALSE, include=FALSE}

# Carregar pacotes 

library(magrittr)
library(dplyr)
library(glue)
library(lattice)
library(sp)
library(raster)
library(caret)
library(georob)
library(gstat)
library(fifer)
library(gstat)
install.packages("")

```

```{r}

# Sistemas de referência de coordenadas (Fonte: http://spatialreference.org/ref/epsg/)

wgs84utm21s <- sp::CRS('+proj=utm +zone=21 +south +ellps=WGS84 +datum=WGS84 +units=m +no_defs')
wgs84 <- sp::CRS('+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs')

# Definir rampa de cores
  col_soil_var1 <- topo.colors(100)
 
```
# ATIVIDADE 

# Realizar a modelagem geoestatística do carbono orgânico do solo

# Caracterização da área de estudo
Os dados utilizados para realizar essa atividade foram obtigos em uma área de ~ 940 ha no município de Giruá. As amostras de solo foram coletadas em 261 pontos na camada de 0-5 cm de forma intencional. O suporte amostral foi em BLOCO (área de ~ 36 m^2), no entanto, para reliazar a atividade foi assumido que o suporte amostral foi de PONTO. 
Nessa atividade foi realizada a predição da variável de solo "Carbono Orgânico do Solo" utilizando o Modelo Linar Misto de Variação Especia. No final da atividade foi realizada uma simulação sequencial gaussiana condicional.

```{r}
# Carregar arquivo vetorial referente ao uso da terra de Giruá
data_folder <- '../data/'
ext <- c('dbf', 'prj', 'shp', 'shx')
files <- glue('uso-da-terra.{ext}')
download <- !all(files %in% list.files(data_folder)) 

```

```{r}
# Gerar mapa do uso da terra 

cobertura <- 
  glue('{data_folder}uso-da-terra.shp') %>% 
  raster::shapefile(stringsAsFactors = TRUE) %>% 
  sp::spTransform(wgs84)
str(cobertura, 2)

```

```{r}
sp::spplot(
  cobertura, scales = list(draw = TRUE), col.regions = terrain.colors(nlevels(cobertura$uso)),
main = "Mapa de uso da terra")

```

```{r}
# Carregar planilha contento variáveis dos 261 pontos de amostragem, camada 0 - 5 cm

pontos <- read.csv('../data/pontos-261-1.csv', sep = ";", dec = ".", h=T)
sp::coordinates(pontos) <- c('x', 'y')
sp::proj4string(pontos) <- wgs84utm21s
str(pontos)
pontos <- sp::spTransform(pontos, wgs84)
pontos@data

```

```{r, fig.asp=1}
# estatística descritiva dos pontos de carbono orgânico do solo (soc)
op <- par(mfrow = c(1, 2))
summary(pontos)
hist(pontos$soc)
boxplot(pontos$soc)
par (op)
```

```{r}
# Gerar mapa de uso da terra com os 261 pontos de amostragem

sp::spplot(
  cobertura, scales = list(draw = TRUE), 
  xlim = extendrange(c(pontos@bbox[1, ], cobertura@bbox[1, ])),
  ylim = extendrange(c(pontos@bbox[2, ], cobertura@bbox[2, ])),
  col.regions = terrain.colors(nlevels(cobertura$uso)),
main = "Localização das 261 observações") +
  lattice::xyplot(y ~ x, data = as.data.frame(pontos@coords), pch = 20, col = 'black') %>% 
  latticeExtra::as.layer()

```

```{r}
## carregar covariáveis preditoras obtidas no TOPODATA (30 m) e mapa de uso da terra

elev <- raster::raster('../data/ELEV.tif')
sp::proj4string(elev)<-wgs84

decli <- raster::raster('../data/decli.tif')
sp::proj4string(decli)<-wgs84

vertnum <- raster::raster('../data/vertnum.tif')
sp::proj4string(vertnum)<-wgs84

horiznum <- raster::raster('../data/horiznum.tif')
sp::proj4string(vertnum)<-wgs84

uso <- raster::raster('../data/uso.tif')
sp::proj4string(uso)<-wgs84

```

```{r}
# extrair valores da covariávies para os 261 pontos

pontos$elev <- raster::extract(elev, pontos)

pontos$decli <- raster::extract(decli, pontos)

pontos$vertnum <- raster::extract(vertnum, pontos)

pontos$horiznum <- raster::extract(horiznum, pontos)

pontos$uso <- raster::extract(uso, pontos) %>% as.factor()

pontos@data

```
#  Modelo de predição de carbono orgânico por Randon Forest 

```{r}
# criar modelo de predição de SOC por Randon Forest 

soc_rf <- caret::train((soc ~ elev + decli + vertnum + horiznum + uso), data = pontos@data, method = "rf", tuneLength = 1, ntree = 500, importance = TRUE, na.action = na.omit, trControl = trainControl("LOOCV"))

```

```{r}
# gerar gráfico para viasualização dos resíduos da predição

op <- par(mfrow = c(2, 2))
pontos@data$socpred <- soc_rf$finalModel$predicted
fig <- stats::lm(soc ~ socpred, data= pontos) 
plot(fig, which = 1:4)

par(op)

```

```{r}

# Fazer a predição espacial para toda área a partir do modelo gerado - soc_rf

beginCluster()
prediction <-
  clusterR(brick(elev, decli, vertnum, horiznum, uso), raster::predict, args = list(model = soc_rf, type = 'raw', inde = 1))
endCluster()
plot(prediction, main = "Mapa de carbono orgânico - modelo determinístico")

```

```{r}
# Criar o objeto "socprediction" na arquivo "pontos"

pontos$socprediction <- raster::extract(prediction, pontos)
pontos@data

```

# Construir o Modelo Linear Misto de Variação Espacial

```{r}
# Calcular a distância em entre pontos e gerar o varigrama amostral
distmax <- dist(pontos@coords) %>% 
  max()/4

# O valor predito de SOC pelo  modelo "soc_rf" foi o efeito fixo do Modelo Linear Misto de Variação Espacial 

limites <- seq(0, distmax, length.out = 10)
vario <- georob::sample.variogram(soc ~ socprediction, data = pontos,
    locations = ~ x + y, lag.dist.def = limites, estimador = 'matheron') %>% 
  plot(ylab = 'Semivariância', xlab = 'Distância de separação', annotate.npairs = T)
```

```{r}
# Ajuste do variograma amostral a um modelo exponencial 
# Foi utilizdo O método dos quadrados mínimos não-lineares ponderados, sendo a ponderação definida conforme o método de "Cressie"
# As estimativas dos parâmetros do modelo foi realizada pelo método "BFGS"

vario_fit <-
  georob::fit.variogram.model(vario, variogram.model = 'RMexp', param = c(variance = 1.3, nugget = 0.5, scale = 1.7),  weighting.method = "cressie", method = 'BFGS')
summary(vario_fit)
```

```{r}
plot(vario, type = 'b', ylab = 'Semivariância', xlab = 'Distância de separação')
lines(vario_fit, col = 'blue', lty = 'dashed')


```

```{r, warning=FALSE}
# Ajuste do variograma com a sepração da variância estrutural (snugget) e não estrutural (nugget)
# foi fixado o snugget em 0.0025, sendo esse valor referente ao erro de análise de laboratório

vario_fit_error <- georob::georob(
   soc ~ socprediction, pontos, locations = ~ x + y, variogram.model = 'RMexp', 
 param = c(variance = vario_fit$variogram.object[[1]]$param[['variance']], 
           nugget = 0.0025,
           snugget = vario_fit$variogram.object[[1]]$param[['nugget']]-0.0025,
           scale = vario_fit$variogram.object[[1]]$param[['scale']]),
 fit.param = georob::default.fit.param(nugget = FALSE, snugget = FALSE),
 tuning.psi = 1000, control = georob::control.georob(initial.fixef = 'lm'))
summary(vario_fit_error)
```

```{r}
plot(vario, ylab = 'Semivariância', xlab = 'Distância de separação')
lines(vario_fit_error, col = "red", lty = 'dashed')

```

```{r}
# criar grid para realizar a predição pelo Modelo Linear Misto de Variação Espacial
grid <- sp::spsample(cobertura, 10000, type = 'regular')
plot(grid@coords, asp=1)
colnames(grid@coords) <- colnames(pontos@coords)
```

```{r}
# Inserir o valor predido "prediction" no grid

grid$socprediction <- raster::extract(prediction, grid)

```


```{r}
grid <- 
 sp::SpatialPointsDataFrame(
   coords = grid@coords, 
   data = data.frame(grid),
   proj4string = grid@proj4string)
colnames(grid@coords) <- colnames(pontos@coords)
```

```{r}
pred_ponto <- predict(vario_fit_error, newdata = grid, na.action = na.omit, control = georob::control.predict.georob(extended.output = F))
sp::gridded(pred_ponto) <- TRUE
sp::spplot(pred_ponto)

plot(pred_ponto, main = "Mapa de carbono orgânico gerado pelo modelo linear misto de variação espacial")

```

```{r, fig.asp=1}
# validar o mapa utilizando os 261-1 pontos

validacao <- georob::cv(vario_fit_error, nset = 260)
summary(validacao)
1 - sum((validacao$pred$data - validacao$pred$pred)^2) / sum((validacao$pred$data - mean(validacao$pred$data))^2)
plot(validacao)
```

# Simulação sequencial gaussiana condicional

```{r}

# Simulação 

m_exp <- gstat::vgm(psill = 13.784, model = 'Exp', range = 2.11, nugget = 0.61)

cond_sim <- gstat::krige(soc ~ socprediction, pontos, grid, model = m_exp, nmax = 15, nsim = 8)

```

```{r}
gridded(cond_sim) <- TRUE
spplot(cond_sim)

```
```{r}
cond_sim_prop <- 
  calc(stack(cond_sim), function (x) x > 5) %>% 
  calc(sum) %>% 
  calc(function (x) x / 8)
plot(cond_sim_prop, asp = 1)

```

